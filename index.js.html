<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint no-console: 0 */
const path = require('path');
const fs = require('fs');
const readline = require('readline');

const program = require('commander');

const { version } = require('./package.json');
const PackingChain = require('./src/packingChain');
const { toNumberArray, isArrayOfNumbers } = require('./src/utils');

// hack commander for usage display
program._name = 'npm';
program
    .version(version)
    .usage('run pack -- [options]')
    .option('-c, --capacity [capacity]', 'The package capacity. Defaults to 10')
    .option('-s, --separator [separator]', 'A string to separate packages to ship')
    .option('-t, --things [things]', 'The things to pack')
    .option('-f, --file [file]', 'A file containing a list of things to pack')
    .parse(process.argv);

const DEFAULT_CHAIN_CAPACITY = 10;
const DEFAULT_PACKAGE_SEPARATOR = '/';

if (!program.things &amp;&amp; !program.file) {
    console.error('ðŸ‘® Specify either a file to read or a sequence of things to package');
    process.exit(-1);
}

/**
 * Read the content of a file and convert it to a array of numbers
 * @async
 * @param {String} file              - the file to read
 * @returns {Promise&lt;Array&lt;Number>>} - The things to pack
 */
async function processFile (file) {
    return new Promise((resolve, reject) => {
        const things = [];
        let lineReader;
        let readStream;
        try {
            readStream = fs.createReadStream(path.resolve(file));
            readStream.on('error', error => reject(error));
            lineReader = readline.createInterface({
                input: readStream
            });
        } catch (error) {
            reject(error);
        }
        lineReader
            .on('line', line => {
                try {
                    line &amp;&amp; things.push(toNumberArray(line));
                } catch (error) {
                    reject(error);
                }
            })
            .on('close', () => {
                resolve(things);
            });
    });
}

/**
 * Grab the things to pack and start the chain to send packages to the customers
 * @async
 * @returns {Promise&lt;String>} - The ðŸ“¦, filled with goodies
 * @throws {TypeError}        - If some of the things provided are weird and cannot be packed by the chain
 * @throws {Error}            - If something went wrong during the processing of the file
 */
async function runPackingChain () {
    let things = [];
    const CHAIN_CAPACITY = program.capacity || DEFAULT_CHAIN_CAPACITY;
    const PACKAGE_SEPARATOR = program.separator || DEFAULT_PACKAGE_SEPARATOR;
    if (program.file) {
        try {
            const fileThings = await processFile(program.file);
            things = [...things, ...fileThings];
        } catch (error) {
            throw error;
        }
    }
    if (program.things) {
        things.push(toNumberArray(program.things));
    }

    const validThings = things.every(thing => isArrayOfNumbers(thing));
    if (!validThings) {
        throw new TypeError('ðŸ’¥ Some of your things cannot be packed and that broke the chain');
    }
    const chain = new PackingChain(CHAIN_CAPACITY, PACKAGE_SEPARATOR);
    chain.pack(...things);
    const delivery = chain.ship();
    return Promise.resolve(delivery);
}

console.log('ðŸ“¦ Packing you things...');
runPackingChain()
    .then(delivery => {
        console.log('ðŸšš Your packages are now in transit:', delivery);
        process.exit(0);
    }).catch(error => {
        console.error(`ðŸ’¥ The chain broke ! Here is what our teams report:
${error.message}
`);
        process.exit(-1);
    });
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-package.html">package</a></li><li><a href="module-packingChain.html">packingChain</a></li></ul><h3>Classes</h3><ul><li><a href="module-packingChain-PackingChain.html">PackingChain</a></li><li><a href="Package.html">Package</a></li><li><a href="PackageNotEnoughSpace.html">PackageNotEnoughSpace</a></li></ul><h3>Global</h3><ul><li><a href="global.html#processFile">processFile</a></li><li><a href="global.html#runPackingChain">runPackingChain</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Nov 27 2017 15:21:17 GMT+0000 (UTC)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
